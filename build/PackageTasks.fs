module PackageTasks

open ProjectInfo

open MessagePrompts
open BasicTasks
open TestTasks

open BlackFox.Fake
open Fake.Core
open Fake.IO.Globbing.Operators

open System.IO

/// copy the fresh nuget packages to fornax test client dependency folder
let copy_nupkg() =
    // copy the fresh nuget packages to fornax test client dependency folder
    let files = Directory.GetFiles(pkgDir, "*.nupkg") |> Array.filter (fun x -> x.Contains "Nfdi4Plants.Fornax.Template" |> not)
    Trace.trace "Copy .nupkg files to test client dependency folder"
    files |> Array.iter (fun x -> 
        let fileName = Path.GetFileName(x)
        let fullPath = Path.GetFullPath(fornaxTestClientDependencies)
        let targetFilePath = Path.Combine(fullPath, fileName)
        if File.Exists targetFilePath then
            File.Delete targetFilePath
        File.Copy(x, targetFilePath)
    )

open System.Text.RegularExpressions

let commitLinkPattern = @"\[\[#[a-z0-9]*\]\(.*\)\] "

let replaceCommitLink input= Regex.Replace(input,commitLinkPattern,"")    

let pack = BuildTask.create "Pack" [clean; build; runTests] {
    if promptYesNo (sprintf "creating stable package with version %s OK?" stableVersionTag ) 
        then
            !! "src/**/*.*proj"
            -- "src/bin/*"
            |> Seq.iter (Fake.DotNet.DotNet.pack (fun p ->
                let msBuildParams =
                    {p.MSBuildParams with 
                        Properties = ([
                            "Version",stableVersionTag
                            "PackageReleaseNotes",  (release.Notes |> String.concat  "\r\n" |> replaceCommitLink)
                        ] @ p.MSBuildParams.Properties)
                    }
                {
                    p with 
                        MSBuildParams = msBuildParams
                        OutputPath = Some pkgDir
                }
            ))
            copy_nupkg()
    else failwith "aborted"
}

let packPrerelease = BuildTask.create "PackPrerelease" [setPrereleaseTag; clean; build; runTests] {
    if promptYesNo (sprintf "package tag will be %s OK?" prereleaseTag )
        then 
            !! "src/**/*.*proj"
            -- "src/bin/*"
            |> Seq.iter (Fake.DotNet.DotNet.pack (fun p ->
                        let msBuildParams =
                            {p.MSBuildParams with 
                                Properties = ([
                                    "Version", prereleaseTag
                                    "PackageReleaseNotes",  (release.Notes |> String.toLines |> replaceCommitLink)
                                ] @ p.MSBuildParams.Properties)
                            }
                        {
                            p with 
                                VersionSuffix = Some prereleaseSuffix
                                OutputPath = Some pkgDir
                                MSBuildParams = msBuildParams
                        }
            ))
            copy_nupkg()
    else
        failwith "aborted"
}